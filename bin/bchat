#!/bin/bash
# bchat - Context-Aware AI Chat Processor

# Resolve the project root directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Activate virtual environment
VENV_PATH="$PROJECT_ROOT/dev/venv"
if [ -f "$VENV_PATH/bin/activate" ]; then
    source "$VENV_PATH/bin/activate"
else
    echo "Warning: Virtual environment not found at $VENV_PATH" >&2
fi

PYTHON_EXEC="python3"
MONITOR_SCRIPT="$PROJECT_ROOT/core/src/chat_monitor.py"

# Handle status command
if [ "$1" = "--status" ]; then
    "$PROJECT_ROOT/bin/bchat-status"
elif [ "$1" = "--start-server" ]; then
    # Check if the MCP server is running
    if ! pgrep -f "mcp_server.py" > /dev/null; then
        # Start the MCP server in http mode in the background
        python3 "$PROJECT_ROOT/mcp_server.py" &
        # Wait for the server to start
        sleep 2
    fi
elif [ "$1" = "--stop-server" ]; then
    # Stop the MCP server
    pkill -f "mcp_server.py"
# Handle status command
if [ "$1" = "--status" ]; then
    "$PROJECT_ROOT/bin/bchat-status"
elif [ "$1" = "--start-server" ]; then
    # Check if the MCP server is running
    if ! pgrep -f "mcp_server.py" > /dev/null; then
        # Start the MCP server in http mode in the background
        python3 "$PROJECT_ROOT/mcp_server.py" &
        # Wait for the server to start
        sleep 2
    fi
elif [ "$1" = "--stop-server" ]; then
    # Stop the MCP server
    pkill -f "mcp_server.py"
elif [ "$1" = "-p" ]; then
    # Handle the -p flag for prompts
    shift # remove the -p
    "$PYTHON_EXEC" "$MONITOR_SCRIPT" "$@"
else
    # All other arguments are treated as the prompt
    "$PYTHON_EXEC" "$MONITOR_SCRIPT" "$@"
fi
